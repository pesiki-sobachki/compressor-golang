# Go Image Compressor Service

–í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è —Å–∂–∞—Ç–∏—è –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –Ω–∞–ø–∏—Å–∞–Ω–Ω—ã–π –Ω–∞ Go.
–ü—Ä–æ–µ–∫—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –ø—Ä–∏–Ω—Ü–∏–ø–∞—Ö **–ì–µ–∫—Å–∞–≥–æ–Ω–∞–ª—å–Ω–æ–π –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (Ports and Adapters)**.

–í –∫–∞—á–µ—Å—Ç–≤–µ –¥–≤–∏–∂–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `libvips` (—á–µ—Ä–µ–∑ –ø–∞–∫–µ—Ç `bimg`), —á—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–µ—Ä–≤–∏—Å —á—Ä–µ–∑–≤—ã—á–∞–π–Ω–æ –±—ã—Å—Ç—Ä—ã–º –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º –ø–æ –ø–∞–º—è—Ç–∏.

---

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

*   **–î–≤–∞ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã:**
    1.  **Storage Mode:** –°–∂–∞—Ç–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –Ω–∞ –¥–∏—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞.
    2.  **Streaming Mode:** –°–∂–∞—Ç–∏–µ "–Ω–∞ –ª–µ—Ç—É" (in-memory) –∏ –≤–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.
*   **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–æ–≤:** –ü–æ–¥–¥–µ—Ä–∂–∫–∞ JPEG, PNG, WEBP.
*   **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ó–∞—â–∏—Ç–∞ –æ—Ç Path Traversal (–≤—ã—Ö–æ–¥–∞ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏) –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏.
*   **–ß–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–∞ –æ—Ç —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤ –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫.

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

–ü—Ä–æ–µ–∫—Ç —Å–ª–µ–¥—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É `Standard Go Project Layout`:

```text
/
‚îú‚îÄ‚îÄ cmd/
‚îÇ   ‚îî‚îÄ‚îÄ api/                 # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (main), —Ç–æ–ª—å–∫–æ wiring
‚îú‚îÄ‚îÄ internal/                # –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ adapter/             # –ê–¥–∞–ø—Ç–µ—Ä—ã (ports implementations)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ inbound/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ http/        # HTTP-—Ö–µ–Ω–¥–ª–µ—Ä—ã (Gin)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ outbound/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ processor/   # –ö–æ–º–ø—Ä–µ—Å—Å–æ—Ä—ã (bimg –∏ –¥—Ä.)
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ bimg/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ repository/  # –•—Ä–∞–Ω–∏–ª–∏—â–∞
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ local/   # –õ–æ–∫–∞–ª—å–Ω–∞—è –§–° + –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—É—Ç–µ–π
‚îÇ   ‚îÇ               ‚îú‚îÄ‚îÄ pathvalidator/
‚îÇ   ‚îÇ               ‚îî‚îÄ‚îÄ storage.go
‚îÇ   ‚îî‚îÄ‚îÄ pkg/
‚îÇ       ‚îî‚îÄ‚îÄ core/            # –Ø–¥—Ä–æ (Domain, Ports, Services)
‚îÇ           ‚îú‚îÄ‚îÄ domain/      # –ú–æ–¥–µ–ª–∏ (File, Options)
‚îÇ           ‚îú‚îÄ‚îÄ port/        # –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã (Processor, Repository)
‚îÇ           ‚îî‚îÄ‚îÄ service/     # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (Process, CompressAndSave, GetFile)
‚îî‚îÄ‚îÄ storage/                 # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Ñ–∞–π–ª–æ–≤ (—Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ)
```

## üõ† API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É `:8080`.

### 1. –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (Storage Mode)

**`POST /upload`**
–°–∂–∏–º–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ–≥–æ –Ω–∞ –¥–∏—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã (Multipart/Form-Data):**
*   `image`: –§–∞–π–ª (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
*   `format`: `jpeg` | `png` | `webp` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `jpeg`)
*   `quality`: `1-100` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `80`)

**–ü—Ä–∏–º–µ—Ä:**
```bash
curl -X POST http://localhost:8080/upload \
  -F "image=@/path/to/photo.jpg" \
  -F "format=webp"
```

**–û—Ç–≤–µ—Ç (JSON):**
```json
{
  "status": "success",
  "compressed_path": "storage/compressed/uuid.webp",
  "message": "File saved successfully"
}
```

---

### 2. –°–∂–∞—Ç–∏–µ "–Ω–∞ –ª–µ—Ç—É" (Streaming Mode)

**`POST /process`**
–°–∂–∏–º–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏ –∏ —Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–∞–π–ª –≤ —Ç–µ–ª–µ –æ—Ç–≤–µ—Ç–∞. –ù–∞ –¥–∏—Å–∫–µ –Ω–∏—á–µ–≥–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:** –¢–µ –∂–µ, —á—Ç–æ –∏ —É `/upload`.

**–ü—Ä–∏–º–µ—Ä:**
```bash
# –§–ª–∞–≥ --output –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∏–ª–µ—Ç–µ–≤—à–∏–µ –±–∞–π—Ç—ã –≤ —Ñ–∞–π–ª
curl -X POST http://localhost:8080/process \
  -F "image=@/path/to/photo.jpg" \
  -F "format=png" \
  --output result.png
```

---

### 3. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞

**`GET /file`**
–°–∫–∞—á–∏–≤–∞–µ—Ç —Ä–∞–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ñ–∞–π–ª.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã (Query Param):**
*   `path`: –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É (–ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∏–∑ `/upload`).

**–ü—Ä–∏–º–µ—Ä:**
```bash
curl -v "http://localhost:8080/file?path=compressed/uuid.webp" --output downloaded.webp
```

> **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –≠–Ω–¥–ø–æ–∏–Ω—Ç –∑–∞—â–∏—â–µ–Ω –æ—Ç –∞—Ç–∞–∫ Path Traversal. –ü–æ–ø—ã—Ç–∫–∏ –ø–µ—Ä–µ–¥–∞—Ç—å –ø—É—Ç—å –≤–∏–¥–∞ `../.env` –≤–µ—Ä–Ω—É—Ç –æ—à–∏–±–∫—É –¥–æ—Å—Ç—É–ø–∞.

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (`libvips`) –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ñ–∞–π–ª–µ [INSTALL.md](INSTALL.md).

1.  –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `libvips`.
2.  `go mod download`
3.  `go run cmd/compressor-server/main.go`